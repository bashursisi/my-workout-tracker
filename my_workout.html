<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Personal Workout Tracker</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Arial', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
        }
        
        h1 {
            text-align: center;
            color: #2c3e50;
            margin-bottom: 30px;
            font-size: 2.5em;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.1);
        }
        
        .safety-notice {
            background: linear-gradient(135deg, #ff6b6b, #ffa726);
            color: white;
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 30px;
            text-align: center;
            font-weight: bold;
        }
        
        .nav-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 30px;
            flex-wrap: wrap;
            justify-content: center;
        }
        
        .nav-tab {
            background: linear-gradient(135deg, #4facfe, #00f2fe);
            border: none;
            color: white;
            padding: 12px 25px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 16px;
            transition: all 0.3s ease;
        }
        
        .nav-tab:hover, .nav-tab.active {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.2);
            background: linear-gradient(135deg, #667eea, #764ba2);
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
                
        .day-selector {
            display: flex;
            gap: 10px;
            margin-bottom: 30px;
            flex-wrap: wrap;
            justify-content: center;
        }
        
        .day-btn {
            background: linear-gradient(135deg, #ff9a9e, #fecfef);
            border: none;
            color: #2c3e50;
            padding: 10px 20px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s ease;
            font-weight: bold;
        }
        
        .day-btn:hover, .day-btn.active {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
            background: linear-gradient(135deg, #ff6b6b, #ffa726);
            color: white;
        }
        
        .day-card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 25px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            border-left: 5px solid #4facfe;
            display: none; 
        }
        
        .day-card.active {
            display: block; 
        }
        
        .day-title {
            color: #2c3e50;
            font-size: 1.8em;
            margin-bottom: 20px;
            text-align: center;
            background: linear-gradient(135deg, #667eea, #764ba2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .exercises-list-container { /* Container for dynamically added exercises */
            margin-bottom: 20px;
        }
        
        .exercise {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            transition: all 0.3s ease;
            position: relative; 
        }
        
        .exercise:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }
        
        .exercise-name {
            font-size: 1.3em;
            font-weight: bold;
            color: #2c3e50;
            margin-bottom: 10px;
        }
         .exercise-name-input { 
            font-size: 1.2em; 
            font-weight: bold;
            color: #2c3e50;
            margin-bottom: 10px;
            padding: 8px;
            border: 1px solid #ccc;
            border-radius: 4px;
            width: calc(100% - 100px); 
        }
        
        .exercise-description {
            color: #666;
            margin-bottom: 15px;
            line-height: 1.6;
        }
        .exercise-description a { 
            color: #007bff;
            text-decoration: none;
        }
        .exercise-description a:hover {
            text-decoration: underline;
        }
        
        .alternatives {
            background: #e3f2fd;
            padding: 10px;
            border-radius: 8px;
            margin-bottom: 15px;
        }
        
        .alternatives strong {
            color: #1976d2;
        }
        
        .video-link {
            display: inline-block;
            background: #ff4757;
            color: white !important; 
            padding: 8px 15px;
            text-decoration: none;
            border-radius: 20px;
            font-size: 14px;
            margin-bottom: 15px;
            transition: all 0.3s ease;
        }
        
        .video-link:hover {
            background: #ff3838;
            transform: scale(1.05);
            text-decoration: none; 
        }
        .video-link-input { 
            padding: 8px;
            border: 1px solid #ccc;
            border-radius: 4px;
            width: calc(100% - 100px); 
            margin-bottom: 10px;
            display: block;
        }

        .edit-exercise-btn, .save-exercise-btn, .cancel-exercise-btn, .add-new-exercise-btn {
            background: #6c757d;
            color: white;
            border: none;
            padding: 8px 15px; /* Increased padding */
            font-size: 0.9em; /* Slightly larger font */
            border-radius: 20px; /* Rounded corners */
            cursor: pointer;
            transition: all 0.3s ease;
            margin-left: 10px;
            vertical-align: middle;
        }
        .edit-exercise-btn { margin-bottom: 10px; display: block; margin-left: auto; margin-right: 0; background: #17a2b8;}
        .save-exercise-btn { background: #28a745; }
        .cancel-exercise-btn { background: #dc3545; }
        .add-new-exercise-btn { 
            display: block; 
            margin: 20px auto 10px auto; /* Centered with margin */
            background: linear-gradient(135deg, #1e90ff, #00bfff); /* DodgerBlue to DeepSkyBlue */
        }
        .add-new-exercise-btn:hover {
            background: linear-gradient(135deg, #00bfff, #1e90ff);
            transform: translateY(-1px);
            box-shadow: 0 3px 10px rgba(0,0,0,0.15);
        }


        .edit-controls { margin-top: 10px; text-align: right; } 
        .edit-controls button { margin-left: 5px; }


        .sets-input {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            margin-top: 15px;
        }
        
        .set-group {
            background: white;
            padding: 15px;
            border-radius: 8px;
            border: 2px solid #e0e0e0;
            min-width: 200px; 
        }
        
        .set-group h4 {
            color: #2c3e50;
            margin-bottom: 10px;
        }
        
        .input-row {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
            align-items: center;
        }
        
        .input-row input {
            width: 60px;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 5px;
            text-align: center;
        }
        
        .input-row label {
            font-size: 14px;
            color: #666;
        }
        
        .save-btn {
            background: linear-gradient(135deg, #56ab2f, #a8e6cf);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 20px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s ease;
            display: block; 
            margin: 20px auto 0 auto; 
        }
        
        .save-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }
        
        .progress-summary {
            background: linear-gradient(135deg, #ffecd2, #fcb69f);
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 30px;
        }
        
        .progress-chart {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .chart-card {
            background: white;
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }
        
        .chart-title {
            font-size: 1.2em;
            font-weight: bold;
            color: #2c3e50;
            margin-bottom: 15px;
            text-align: center;
        }
        
        .rest-day {
            background: linear-gradient(135deg, #a8edea, #fed6e3);
            text-align: center;
            padding: 40px;
            border-radius: 15px;
        }
        
        .swimming-day {
            background: linear-gradient(135deg, #00c6ff, #0072ff);
            color: white;
            text-align: center;
            padding: 40px;
            border-radius: 15px;
        }
         .swimming-day .day-title { 
            -webkit-text-fill-color: white;
            color: white;
        }
        
        #progress-entries-container details {
            background: #f9f9f9;
            border: 1px solid #eee;
            border-radius: 8px;
            margin-bottom: 15px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }
        #progress-entries-container summary {
            padding: 15px;
            font-weight: bold;
            cursor: pointer;
            background: linear-gradient(135deg, #e0c3fc, #8ec5fc);
            color: #333;
            border-radius: 8px 8px 0 0;
            outline: none;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        #progress-entries-container summary:hover {
            background: linear-gradient(135deg, #d0b3ec, #7eb5ec);
        }
        #progress-entries-container summary::after { 
            content: '+';
            font-size: 1.5em;
            color: #555;
        }
        #progress-entries-container details[open] summary::after {
            content: '‚àí';
        }
        .progress-entry-details {
            padding: 15px;
            background: white;
            border-top: 1px solid #eee;
        }
        .progress-entry-details h4 {
            margin-top: 10px;
            margin-bottom: 5px;
            color: #2c3e50;
            border-bottom: 1px solid #eee;
            padding-bottom: 5px;
        }
        .progress-entry-details h4:first-child {
            margin-top: 0;
        }

        .progress-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px; 
        }
        
        .progress-table th,
        .progress-table td {
            padding: 10px; 
            text-align: left;
            border-bottom: 1px solid #ddd;
            font-size: 0.9em; 
        }
        
        .progress-table th {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
        }
        
        .progress-table tr:hover {
            background-color: #f5f5f5;
        }
        
        .export-btn {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 25px;
            cursor: pointer;
            font-weight: bold;
            margin: 10px auto; 
            display: block;
            transition: all 0.3s ease;
        }
        
        .export-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }
        
        .monthly-view {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 10px;
            margin-bottom: 30px;
        }
        
        .calendar-day {
            background: white;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 10px;
            text-align: center;
            min-height: 80px;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative; 
        }
        
        .calendar-day:hover {
            background: #f0f0f0;
        }
        
        .calendar-day.workout-complete {
            background: linear-gradient(135deg, #56ab2f, #a8e6cf);
            color: white;
        }
        
        .calendar-day.today {
            border: 3px solid #ff4757;
            font-weight: bold;
        }
         .calendar-day.header {
            font-weight: bold;
            background: #f0f0f0;
            cursor: default;
        }
        .calendar-day.empty {
            background: #f9f9f9;
            cursor: default;
        }

    </style>
</head>
<body>
    <div class="container">
        <h1>üèãÔ∏è‚Äç‚ôÇÔ∏è Personal Workout Tracker</h1>
        
        <div class="safety-notice">
            ‚ö†Ô∏è IMPORTANT: This program is designed for your specific injuries (meniscus tear & hernias). 
            Always warm up, avoid heavy weights on damaged areas, and stop if you feel pain! Consult a doctor or physical therapist before starting any new exercise program.
        </div>
        
        <div class="nav-tabs">
            <button class="nav-tab active" onclick="showTab('workout', this)">Workout</button>
            <button class="nav-tab" onclick="showTab('progress', this)">Progress</button>
            <button class="nav-tab" onclick="showTab('calendar', this)">Calendar</button>
            <button class="nav-tab" onclick="showTab('analytics', this)">Analytics</button>
        </div>
        
        <div id="workout-tab" class="tab-content active">
            <div class="day-selector">
                <button class="day-btn" onclick="showDay(1, this)">Day 1: Upper Body</button>
                <button class="day-btn" onclick="showDay(2, this)">Day 2: Lower Body</button>
                <button class="day-btn" onclick="showDay(3, this)">Day 3: Swimming</button>
                <button class="day-btn" onclick="showDay(4, this)">Day 4: Upper Body</button>
                <button class="day-btn" onclick="showDay(5, this)">Day 5: Lower Body</button>
                <button class="day-btn" onclick="showDay(6, this)">Day 6: Cardio/Core</button>
                <button class="day-btn" onclick="showDay(7, this)">Day 7: Rest</button>
            </div>
            
            <div id="day1" class="day-card">
                <h2 class="day-title">Day 1: Upper Body Strength</h2>
                <div class="exercises-list-container">
                    </div>
                <button class="add-new-exercise-btn" data-dayid="day1">Add New Exercise</button>
                <button class="save-btn" onclick="saveWorkout('day1')">Save Day 1 Progress</button>
            </div>

            <div id="day2" class="day-card">
                <h2 class="day-title">Day 2: Lower Body (Knee-Safe)</h2>
                <div class="exercises-list-container">
                    </div>
                <button class="add-new-exercise-btn" data-dayid="day2">Add New Exercise</button>
                <button class="save-btn" onclick="saveWorkout('day2')">Save Day 2 Progress</button>
            </div>

            <div id="day3" class="day-card"> <div class="swimming-day">
                    <h2 class="day-title">Day 3: Swimming & Pool Workout</h2>
                    <p style="font-size: 1.2em; margin-bottom: 20px;">üèä‚Äç‚ôÇÔ∏è Perfect low-impact cardio for your injuries! Adjust frequency as desired.</p>
                    <div style="background: rgba(255,255,255,0.2); padding: 20px; border-radius: 10px; margin: 20px 0;">
                        <h3>Swimming Routine (30-45 minutes)</h3>
                        <p>‚Ä¢ 5 min warm-up: Easy freestyle or backstroke</p>
                        <p>‚Ä¢ 20-30 min main set: Mix of strokes, focus on form</p>
                        <p>‚Ä¢ 5-10 min cool-down: Easy swimming or water walking</p>
                    </div>
                    <div style="background: rgba(255,255,255,0.2); padding: 20px; border-radius: 10px;">
                        <h3>Water Aerobics / Gentle Movements (15-20 minutes, optional)</h3>
                        <p>‚Ä¢ Leg Kicks (holding onto side)</p>
                        <p>‚Ä¢ Arm Circles</p>
                        <p>‚Ä¢ Water Walking (forward, backward, sideways)</p>
                    </div>
                     <button class="save-btn" style="margin-top: 20px;" onclick="saveWorkout('day3')">Log Swimming Session</button>
                </div>
            </div>

            <div id="day4" class="day-card">
                <h2 class="day-title">Day 4: Upper Body Focus</h2>
                <div class="exercises-list-container">
                     </div>
                <button class="add-new-exercise-btn" data-dayid="day4">Add New Exercise</button>
                <button class="save-btn" onclick="saveWorkout('day4')">Save Day 4 Progress</button>
            </div>

            <div id="day5" class="day-card">
                <h2 class="day-title">Day 5: Lower Body Focus</h2>
                <div class="exercises-list-container">
                    </div>
                <button class="add-new-exercise-btn" data-dayid="day5">Add New Exercise</button>
                <button class="save-btn" onclick="saveWorkout('day5')">Save Day 5 Progress</button>
            </div>
            
            <div id="day6" class="day-card"> <h2 class="day-title">Day 6: Light Cardio & Core</h2>
                <div class="exercise" data-exercise-id="day6_ex1"> <button class="edit-exercise-btn">Edit Exercise</button>
                    <div class="exercise-name">Stationary Bike or Elliptical Trainer</div>
                    <div class="exercise-description">
                        Low-impact cardiovascular exercise. Adjust resistance/incline to a comfortable level.
                        <br>Bike Demo: <a href="https://www.youtube.com/watch?v=xFG3xY5e6go" target="_blank" class="video-link" style="font-size:0.8em; padding: 4px 8px; margin-bottom: 5px;">üì∫ Bike Setup</a>
                        <br>Elliptical Demo: <a href="https://www.youtube.com/watch?v=r3ALgD334dY" target="_blank" class="video-link" style="font-size:0.8em; padding: 4px 8px;">üì∫ Elliptical Use</a>
                        <p><strong>Duration:</strong> 20-30 minutes</p>
                        <p><strong>Intensity:</strong> Light to Moderate (able to hold a conversation)</p>
                    </div>
                     <div class="sets-input"> 
                        <div class="set-group"><h4>Cardio Session</h4><div class="input-row"><label>Duration (min):</label><input type="number" id="day6_ex1_s1_duration" placeholder="20-30"><label>Notes:</label><input type="text" id="day6_ex1_s1_notes" placeholder="Bike/Elliptical?" style="width:100px;"></div></div>
                    </div>
                </div>
                <div class="exercise"> <div class="exercise-name">Core (Hernia-Safe)</div>
                     <div class="exercise-description">
                        Focus on gentle core engagement. Avoid crunches or sit-ups. Perform slowly and with control.
                        <p>‚Ä¢ <strong>Pelvic Tilts:</strong> 3 sets of 10-15 reps <a href="https://www.youtube.com/watch?v=r_srf_7sYlc" target="_blank" class="video-link" style="font-size:0.8em; padding: 4px 8px; margin-left:5px;">üì∫ Demo</a></p>
                        <p>‚Ä¢ <strong>Heel Slides:</strong> 3 sets of 10-15 reps per leg <a href="https://www.youtube.com/watch?v=5oY4aZ3Eq3Y" target="_blank" class="video-link" style="font-size:0.8em; padding: 4px 8px; margin-left:5px;">üì∫ Demo</a></p>
                        <p>‚Ä¢ <strong>Bird-Dog (modified if needed):</strong> 3 sets of 8-10 reps per side <a href="https://www.youtube.com/watch?v=wiFNA3sqjCA" target="_blank" class="video-link" style="font-size:0.8em; padding: 4px 8px; margin-left:5px;">üì∫ Demo</a></p>
                        <p>‚Ä¢ <strong>Dead Bug (modified, e.g., only leg movements or only arm movements):</strong> 3 sets of 8-10 reps per side <a href="https://www.youtube.com/watch?v=g_BYB0R-DRM" target="_blank" class="video-link" style="font-size:0.8em; padding: 4px 8px; margin-left:5px;">üì∫ Demo</a></p>
                    </div>
                     <div class="sets-input">
                        <div class="set-group"><h4>Core Completion</h4><div class="input-row"><label>Completed:</label><input type="checkbox" id="day6_ex2_s1_completed" style="width:auto;"> <label>Notes:</label><input type="text" id="day6_ex2_s1_notes" placeholder="Any discomfort?" style="width:100px;"></div></div>
                    </div>
                </div>
                <button class="save-btn" onclick="saveWorkout('day6')">Log Cardio & Core</button>
            </div>

            <div id="day7" class="day-card"> <div class="rest-day">
                    <h2 class="day-title" style="-webkit-text-fill-color: #2c3e50; color: #2c3e50;">Day 7: Rest & Recovery</h2>
                    <p style="font-size: 1.2em; margin-bottom: 20px;">üßò‚Äç‚ôÇÔ∏è Your body needs time to repair and rebuild. Enjoy your rest day!</p>
                    <p>Focus on: Light stretching, hydration, good nutrition. Consider sauna if available and you enjoy it for recovery.</p>
                </div>
                 <button class="save-btn" onclick="saveWorkout('day7')">Log Rest Day</button>
            </div>

        </div>

        <div id="progress-tab" class="tab-content">
            <h2>Track Your Progress</h2>
            <p>This section shows your saved workout data. Click a date to expand/collapse details.</p>
            <div class="progress-summary">
                <h3>Overall Summary</h3>
                <p>Workouts Logged: <span id="workouts-completed">0</span></p>
                <p>Total Volume (Approx. KG x Reps): <span id="total-volume">0</span></p>
            </div>
            <div class="progress-chart">
                <div class="chart-card">
                    <h3 class="chart-title">Volume Over Time (Example)</h3>
                    <canvas id="volumeChart"></canvas>
                </div>
                 <div class="chart-card">
                    <h3 class="chart-title">Workouts Per Week (Example)</h3>
                    <canvas id="frequencyChart"></canvas>
                </div>
            </div>
             <div id="progress-entries-container">
                 <p style="text-align:center;">No data saved yet. Click "Save Day X Progress" after workouts.</p>
             </div>
            <button class="export-btn" onclick="exportProgress()">Export Progress (CSV)</button>
        </div>

        <div id="calendar-tab" class="tab-content">
            <h2>Workout Calendar</h2>
            <p>View your completed workouts. Click a day to see the planned workout for that day of the week in the 'Workout' tab.</p>
            <div class="monthly-view" id="monthly-calendar-view">
            </div>
        </div>

        <div id="analytics-tab" class="tab-content">
            <h2>Workout Analytics</h2>
            <p>Deeper insights into your workout patterns and performance. (Future Feature)</p>
        </div>

    </div>

    <script>
        // --- Global Exercise Plan Storage ---
        let exercisePlanData = {};
        const EXERCISE_PLAN_STORAGE_KEY = 'exercisePlanTemplatesV2'; // Incremented version for new structure
        const WORKOUT_LOG_STORAGE_KEY = 'workoutLogV5'; // Incremented version

        // --- Initial HTML Structure for Exercises (used by initializeExercisePlan if localStorage is empty) ---
        const initialExerciseStructures = {
            day1: [
                { id: "day1_ex1", name: "Seated Chest Press Machine", videoLink: "https://www.youtube.com/watch?v=x3bJInRNvQA", description: "Builds chest, shoulders, and triceps while providing back support. Perfect for hernias as it eliminates spinal loading.", alternatives: "Incline Push-ups (hands elevated), Dumbbell Bench Press (light, controlled, back supported)" },
                { id: "day1_ex2", name: "Seated Cable Row", videoLink: "https://www.youtube.com/watch?v=GZbfZ033f74", description: "Strengthens back muscles and improves posture. Seated position protects your hernias while building a strong back.", alternatives: "Seated Resistance Band Rows, Dumbbell Rows (one arm, supported on bench)" },
                { id: "day1_ex3", name: "Seated Shoulder Press Machine", videoLink: "https://www.youtube.com/watch?v=02t_gBL2c9E", description: "Builds shoulder strength and size. Seated position provides back support and prevents strain on your hernias.", alternatives: "Seated Dumbbell Shoulder Press (light, back supported), Resistance Band Overhead Press" },
                { id: "day1_ex4", name: "Seated Dumbbell Bicep Curls", videoLink: "https://www.youtube.com/watch?v=NFzTWp2qpiE", description: "Isolates biceps for growth. Seated position prevents cheating and protects your back from strain.", alternatives: "Cable Bicep Curls (standing or seated), Resistance Band Curls" }
            ],
            day2: [
                { id: "day2_ex1", name: "Leg Press Machine", videoLink: "https://www.youtube.com/watch?v=IZxyjW7MPJQ", description: "Builds leg strength without stressing knees. Supported position protects hernias. Keep feet high on platform to reduce knee stress.", alternatives: "Wall Sits (short duration), Bodyweight Box Squats (to a high box/chair)" },
                { id: "day2_ex2", name: "Glute Bridges", videoLink: "https://www.youtube.com/watch?v=8bbE64Nu_2A", description: "Strengthens glutes and hamstrings while being gentle on knees and back. Great for core stability too.", alternatives: "Single-leg Glute Bridges (if stable), Resistance Band Glute Bridges (band around thighs)" },
                { id: "day2_ex3", name: "Calf Raises (e.g., Standing)", videoLink: "https://www.youtube.com/watch?v=Jfl4h3qR_lQ", description: "Builds calf muscle. Can be done standing (bodyweight or with dumbbells) or on a leg press if available.", alternatives: "Single-Leg Calf Raises (bodyweight), Calf Raises on a Step, Leg Press Calf Presses. (Original: Seated Calf Raises)" }
            ],
            day4: [
                { id: "day4_ex1", name: "Dumbbell Flyes (on bench)", videoLink: "https://www.youtube.com/watch?v=eozbU_SJZbc", description: "Isolates chest muscles. Use light-moderate weight, focus on controlled movement and squeezing the chest. Keep back supported.", alternatives: "Resistance Band Chest Flyes, Incline Push-ups. (Original: Pec Deck Machine)" },
                { id: "day4_ex2", name: "Machine Lat Pulldown (Wide Grip)", videoLink: "https://www.youtube.com/watch?v=lueEJGjTuPQ", description: "Targets the latissimus dorsi (lats) for back width. Seated position provides good back support. (If no machine: use alternatives).", alternatives: "Resistance Band Pulldowns (anchored high), Wide-Grip Bodyweight Rows (under a sturdy table or bar, feet on floor)" },
                { id: "day4_ex3", name: "Seated Lateral Raises (Dumbbells)", videoLink: "https://www.youtube.com/watch?v=3VcKaXpzqRo", description: "Targets the medial (side) deltoids for shoulder width. Perform with light weight and controlled motion. Back supported.", alternatives: "Resistance Band Lateral Raises, Leaning Dumbbell Lateral Raise (one arm at a time)" },
                { id: "day4_ex4", name: "Cable Tricep Pushdowns (Rope or Bar)", videoLink: "https://www.youtube.com/watch?v=2-LAMcpzODU", description: "Isolates the triceps muscles. Maintain good posture. (If no cable: use alternatives).", alternatives: "Dumbbell Overhead Tricep Extension (seated or standing, one or two hands), Resistance Band Tricep Pushdowns/Overhead Extensions, Close-Grip Push-ups (hands elevated if needed)" },
                { id: "day4_ex5", name: "Dumbbell Concentration Curls", videoLink: "https://www.youtube.com/watch?v=0AUGkch3tzc", description: "Excellent for isolating the biceps. Sit and brace your working arm's elbow against your inner thigh.", alternatives: "Dumbbell Spider Curls (chest on incline bench), Incline Dumbbell Curls. (Original: Machine Preacher Curls)" }
            ],
            day5: [
                { id: "day5_ex1", name: "Leg Press Machine", videoLink: "https://www.youtube.com/watch?v=IZxyjW7MPJQ", description: "Builds leg strength without stressing knees. Supported position protects hernias. (If no machine: use alternatives).", alternatives: "Dumbbell Goblet Squats (light, focus on form), Bodyweight Squats, Wall Sits." },
                { id: "day5_ex2", name: "Sliding Leg Curls (Floor)", videoLink: "https://www.youtube.com/watch?v=y2wAlKcY6iY", description: "Isolates hamstrings. Lie on back, hips bridged, slide feet out and curl back in using socks/towels on a slippery floor.", alternatives: "Resistance Band Hamstring Curls, Glute Bridges with feet further away. (Original: Hamstring Curl Machine)" },
                { id: "day5_ex3", name: "Leg Extension Machine (Light Weight)", videoLink: "https://www.youtube.com/watch?v=YyvSfVjQeL0", description: "Targets the quadriceps. Use very light weight, focus on controlled movement. (If no machine: use alternatives).", alternatives: "Bodyweight Shallow Squats (if no pain), Step-ups onto a low platform (controlled), Terminal Knee Extensions (with band)" },
                { id: "day5_ex4", name: "Glute Bridges", videoLink: "https://www.youtube.com/watch?v=8bbE64Nu_2A", description: "Strengthens glutes and hamstrings while being gentle on knees and back. Great for core stability too.", alternatives: "Single-leg Glute Bridges (if stable), Resistance Band Glute Bridges (band around thighs)" },
                { id: "day5_ex5", name: "Calf Raises (e.g., Standing on Step)", videoLink: "https://www.youtube.com/watch?v=g_s0s4aUStg", description: "Builds calf muscle. Use a step for greater range of motion. Hold dumbbells for added resistance if comfortable.", alternatives: "Single-Leg Calf Raises, Standing Calf Raises (flat ground). (Original: Seated Calf Raises)" }
            ],
             day6: [ // Only the first exercise is part of the dynamic plan for Day 6
                { id: "day6_ex1", name: "Stationary Bike or Elliptical Trainer", videoLink: "https://www.youtube.com/watch?v=xFG3xY5e6go", description: "Low-impact cardiovascular exercise. Adjust resistance/incline to a comfortable level.<br>Bike Demo: <a href='https://www.youtube.com/watch?v=xFG3xY5e6go' target='_blank' class='video-link' style='font-size:0.8em; padding: 4px 8px; margin-bottom: 5px;'>üì∫ Bike Setup</a><br>Elliptical Demo: <a href='https://www.youtube.com/watch?v=r3ALgD334dY' target='_blank' class='video-link' style='font-size:0.8em; padding: 4px 8px;'>üì∫ Elliptical Use</a><p><strong>Duration:</strong> 20-30 minutes</p><p><strong>Intensity:</strong> Light to Moderate (able to hold a conversation)</p>", alternatives: "Swimming, Walking" }
            ]
        };

        // --- Tab Navigation ---
        function showTab(tabId, clickedButton) {
            const tabContents = document.querySelectorAll('.tab-content');
            tabContents.forEach(content => content.classList.remove('active'));
            const navTabs = document.querySelectorAll('.nav-tab');
            navTabs.forEach(tab => tab.classList.remove('active'));

            const selectedTabContent = document.getElementById(tabId + '-tab');
            if (selectedTabContent) selectedTabContent.classList.add('active');
            if (clickedButton) clickedButton.classList.add('active');

            if (tabId === 'calendar') generateCalendar(); 
            if (tabId === 'progress') updateProgressTable();
            if (tabId === 'workout') {
                const activeDayButton = document.querySelector('.day-btn.active');
                if (activeDayButton) {
                    const dayNumber = parseInt(activeDayButton.getAttribute('onclick').match(/showDay\((\d+)/)[1]);
                    renderExercisesForDay('day' + dayNumber); // Ensure plan is rendered
                    populateDayInputs('day' + dayNumber); // Populate with logged data
                }
            }
        }

        // --- Day Selector ---
        function showDay(dayNumber, clickedButton) {
            const dayCards = document.querySelectorAll('.day-card');
            dayCards.forEach(card => card.classList.remove('active'));
            const dayButtons = document.querySelectorAll('.day-btn');
            dayButtons.forEach(button => button.classList.remove('active'));

            const dayId = 'day' + dayNumber;
            const selectedDayCard = document.getElementById(dayId);
            if (selectedDayCard) {
                selectedDayCard.classList.add('active');
                renderExercisesForDay(dayId); 
                populateDayInputs(dayId); 
            }
            if (clickedButton) clickedButton.classList.add('active');
        }
        
        // --- Create Exercise DOM Element ---
        function createExerciseElement(exerciseData, dayId) {
            const exerciseEl = document.createElement('div');
            exerciseEl.classList.add('exercise');
            exerciseEl.dataset.exerciseId = exerciseData.id;

            const editBtn = document.createElement('button');
            editBtn.classList.add('edit-exercise-btn');
            editBtn.textContent = 'Edit Exercise';
            editBtn.onclick = () => makeExerciseEditable(exerciseEl, dayId, exerciseData.id);
            exerciseEl.appendChild(editBtn);

            const nameDiv = document.createElement('div');
            nameDiv.classList.add('exercise-name');
            nameDiv.textContent = exerciseData.name || 'New Exercise';
            exerciseEl.appendChild(nameDiv);

            const descriptionDiv = document.createElement('div');
            descriptionDiv.classList.add('exercise-description');
            // For Day 6, description might contain HTML for its demo links
            if (dayId === 'day6' && exerciseData.id === 'day6_ex1') {
                 descriptionDiv.innerHTML = exerciseData.description || 'Default description.';
            } else {
                descriptionDiv.textContent = exerciseData.description || 'Default description.';
            }
            exerciseEl.appendChild(descriptionDiv);
            
            const alternativesDiv = document.createElement('div');
            alternativesDiv.classList.add('alternatives');
            alternativesDiv.innerHTML = `<strong>Alternatives:</strong> ${exerciseData.alternatives || 'None specified.'}`;
            exerciseEl.appendChild(alternativesDiv);

            // Only add main video link if it's not Day 6's special cardio description
            if (!(dayId === 'day6' && exerciseData.id === 'day6_ex1')) {
                const videoLink = document.createElement('a');
                videoLink.classList.add('video-link');
                videoLink.href = exerciseData.videoLink || '#';
                videoLink.target = '_blank';
                videoLink.innerHTML = 'üì∫ Watch Demo';
                exerciseEl.appendChild(videoLink);
            }


            const setsInputDiv = document.createElement('div');
            setsInputDiv.classList.add('sets-input');
            // For Day 6 cardio, use its specific input structure
            if (dayId === 'day6' && exerciseData.id === 'day6_ex1') {
                setsInputDiv.innerHTML = `
                    <div class="set-group"><h4>Cardio Session</h4>
                        <div class="input-row">
                            <label>Duration (min):</label><input type="number" id="${exerciseData.id}_s1_duration" placeholder="20-30">
                            <label>Notes:</label><input type="text" id="${exerciseData.id}_s1_notes" placeholder="Bike/Elliptical?" style="width:100px;">
                        </div>
                    </div>`;
            } else { // Standard 3 sets for other exercises
                for (let i = 0; i < 3; i++) { 
                    const setGroupDiv = document.createElement('div');
                    setGroupDiv.classList.add('set-group');
                    setGroupDiv.innerHTML = `<h4>Set ${i + 1}</h4>
                        <div class="input-row">
                            <label>Weight:</label><input type="number" id="${exerciseData.id}_s${i + 1}_weight" placeholder="KG">
                            <label>Reps:</label><input type="number" id="${exerciseData.id}_s${i + 1}_reps" placeholder="Reps">
                        </div>`;
                    setsInputDiv.appendChild(setGroupDiv);
                }
            }
            exerciseEl.appendChild(setsInputDiv);
            return exerciseEl;
        }

        // --- Initialize and Manage Exercise Plan ---
        function initializeExercisePlan() {
            const storedPlan = localStorage.getItem(EXERCISE_PLAN_STORAGE_KEY);
            if (storedPlan) {
                exercisePlanData = JSON.parse(storedPlan);
            } else {
                exercisePlanData = {};
                // Populate from initialExerciseStructures
                for (const dayKey in initialExerciseStructures) {
                    exercisePlanData[dayKey] = { exercises: JSON.parse(JSON.stringify(initialExerciseStructures[dayKey])) }; // Deep copy
                }
                localStorage.setItem(EXERCISE_PLAN_STORAGE_KEY, JSON.stringify(exercisePlanData));
            }
        }
        
        // --- Render Exercises for a Given Day ---
        function renderExercisesForDay(dayId) {
            const dayCard = document.getElementById(dayId);
            if (!dayCard) return;

            if (dayId === 'day3' || dayId === 'day7') return; // Static days

            const exercisesContainer = dayCard.querySelector('.exercises-list-container');
            
            if (dayId === 'day6') { // Special handling for Day 6
                const firstExerciseEl = dayCard.querySelector('.exercise[data-exercise-id="day6_ex1"]');
                const plan = exercisePlanData[dayId];
                if (firstExerciseEl && plan && plan.exercises && plan.exercises.length > 0) {
                    const exerciseData = plan.exercises.find(ex => ex.id === "day6_ex1");
                    if (exerciseData) {
                        const nameDisplay = firstExerciseEl.querySelector('.exercise-name');
                        if (nameDisplay) nameDisplay.textContent = exerciseData.name;
                        // Description for Day 6 is complex and includes links, so update its innerHTML
                        const descriptionDisplay = firstExerciseEl.querySelector('.exercise-description');
                        if (descriptionDisplay) descriptionDisplay.innerHTML = exerciseData.description;


                        let editBtn = firstExerciseEl.querySelector('.edit-exercise-btn');
                         if (editBtn) {
                            editBtn.onclick = () => makeExerciseEditable(firstExerciseEl, dayId, exerciseData.id);
                        }
                    }
                }
                return; // Day 6 only updates its first exercise in place, rest is static
            }

            if (!exercisesContainer) return;
            exercisesContainer.innerHTML = ''; 

            const dayPlan = exercisePlanData[dayId];
            if (dayPlan && dayPlan.exercises) {
                dayPlan.exercises.forEach(exerciseData => {
                    const exerciseElement = createExerciseElement(exerciseData, dayId);
                    exercisesContainer.appendChild(exerciseElement);
                });
            }
        }


        function makeExerciseEditable(exerciseElement, dayId, exerciseId) {
            const plan = exercisePlanData[dayId];
            if (!plan || !plan.exercises) return;
            const exerciseData = plan.exercises.find(ex => ex.id === exerciseId);
            if (!exerciseData) return;

            const nameDisplay = exerciseElement.querySelector('.exercise-name');
            const videoLinkDisplay = exerciseElement.querySelector('a.video-link'); 
            const editButton = exerciseElement.querySelector('.edit-exercise-btn');

            const originalName = exerciseData.name;
            const originalLink = exerciseData.videoLink;

            const nameInput = document.createElement('input');
            nameInput.type = 'text';
            nameInput.value = originalName;
            nameInput.classList.add('exercise-name-input');
            if(nameDisplay) nameDisplay.replaceWith(nameInput); else nameInput.value = "Exercise Name";


            let videoLinkInput;
             // For Day 6 cardio, video link editing is not standard due to embedded links.
            if (!(dayId === 'day6' && exerciseId === 'day6_ex1')) {
                if (videoLinkDisplay) {
                    videoLinkInput = document.createElement('input');
                    videoLinkInput.type = 'text';
                    videoLinkInput.value = originalLink || '';
                    videoLinkInput.classList.add('video-link-input');
                    videoLinkDisplay.style.display = 'none'; 
                    videoLinkDisplay.parentNode.insertBefore(videoLinkInput, videoLinkDisplay.nextSibling);
                } else { // If no video link element exists, create one for editing
                    videoLinkInput = document.createElement('input');
                    videoLinkInput.type = 'text';
                    videoLinkInput.value = originalLink || '';
                    videoLinkInput.classList.add('video-link-input');
                    // Insert after description or alternatives if they exist
                    const alternativesEl = exerciseElement.querySelector('.alternatives');
                    if(alternativesEl) alternativesEl.parentNode.insertBefore(videoLinkInput, alternativesEl.nextSibling);
                    else {
                        const descriptionEl = exerciseElement.querySelector('.exercise-description');
                        if(descriptionEl) descriptionEl.parentNode.insertBefore(videoLinkInput, descriptionEl.nextSibling);
                        else nameInput.parentNode.insertBefore(videoLinkInput, nameInput.nextSibling);
                    }
                }
            }


            const saveBtn = document.createElement('button');
            saveBtn.textContent = 'Save';
            saveBtn.classList.add('save-exercise-btn');
            saveBtn.onclick = () => {
                const newName = nameInput.value.trim();
                let newLink = originalLink;
                if (videoLinkInput) newLink = videoLinkInput.value.trim();
                saveExerciseChange(dayId, exerciseId, newName, newLink, exerciseElement);
            };

            const cancelBtn = document.createElement('button');
            cancelBtn.textContent = 'Cancel';
            cancelBtn.classList.add('cancel-exercise-btn');
            cancelBtn.onclick = () => {
                nameInput.replaceWith(nameDisplay); 
                if(nameDisplay) nameDisplay.textContent = originalName; 

                if (videoLinkInput && videoLinkDisplay) {
                    videoLinkInput.remove();
                    videoLinkDisplay.style.display = 'inline-block'; 
                    videoLinkDisplay.href = originalLink;
                } else if (videoLinkInput) { // Link input was created but no original display
                    videoLinkInput.remove();
                }
                
                if(editButton) editButton.style.display = 'block'; 
                controlsDiv.remove();
            };
            
            const controlsDiv = document.createElement('div');
            controlsDiv.classList.add('edit-controls');
            controlsDiv.appendChild(saveBtn);
            controlsDiv.appendChild(cancelBtn);
            
            const targetNodeForControls = videoLinkInput || nameInput;
            targetNodeForControls.parentNode.insertBefore(controlsDiv, targetNodeForControls.nextSibling);
            if(editButton) editButton.style.display = 'none';
        }

        function saveExerciseChange(dayId, exerciseId, newName, newLink, exerciseElement) {
            const plan = exercisePlanData[dayId];
            if (!plan || !plan.exercises) return;
            const exerciseIndex = plan.exercises.findIndex(ex => ex.id === exerciseId);
            if (exerciseIndex === -1) return;

            plan.exercises[exerciseIndex].name = newName;
            // Only update videoLink if it's not the special Day 6 cardio case
            if (!(dayId === 'day6' && exerciseId === 'day6_ex1')) {
                 plan.exercises[exerciseIndex].videoLink = newLink;
            }
            // For Day 6 cardio, if we wanted to edit its description (which contains links)
            // that would be a more complex update. For now, only name is effectively changed in plan.

            localStorage.setItem(EXERCISE_PLAN_STORAGE_KEY, JSON.stringify(exercisePlanData));
            renderExercisesForDay(dayId); // Re-render to reflect changes and restore structure
            alert('Exercise updated!');
        }


        function findLatestWorkoutForDay(dayId) {
            const workoutLog = JSON.parse(localStorage.getItem(WORKOUT_LOG_STORAGE_KEY)) || {}; 
            let latestEntry = null;
            const sortedDates = Object.keys(workoutLog).sort((a, b) => new Date(b) - new Date(a)); 
            for (const date of sortedDates) {
                if (workoutLog[date][dayId]) {
                    latestEntry = workoutLog[date][dayId];
                    break; 
                }
            }
            return latestEntry;
        }
        
        function populateDayInputs(dayId) {
            const dayCard = document.getElementById(dayId);
            if (!dayCard) return;

            const allInputs = dayCard.querySelectorAll('input[type="number"], input[type="text"]');
            allInputs.forEach(input => input.value = '');
            const allCheckboxes = dayCard.querySelectorAll('input[type="checkbox"]');
            allCheckboxes.forEach(checkbox => checkbox.checked = false);
            
            const latestDayData = findLatestWorkoutForDay(dayId);
            if (!latestDayData || !latestDayData.exercises) return; 

            latestDayData.exercises.forEach((loggedExercise, logExIndex) => {
                // Try to find the exercise element by its ID from the plan,
                // which should match how it was logged if saveWorkout used data-exercise-id.
                // The loggedExercise.name might have changed, so we rely on order or need a stable ID in the log.
                // For now, assume order or that loggedExercise.id exists if we add it during save.
                // Let's assume loggedExercise.originalId was stored, or match by order/name for now.

                // Find corresponding exercise element in the DOM by its data-exercise-id
                // This requires that saveWorkout stores exercise.id from the plan with the log.
                // For now, we'll map by index as a fallback if exercise IDs aren't perfectly aligned in logs yet.
                
                const exercisePlan = exercisePlanData[dayId];
                if (!exercisePlan || !exercisePlan.exercises[logExIndex]) return;
                
                const planExerciseId = exercisePlan.exercises[logExIndex].id;
                const exerciseElement = dayCard.querySelector(`.exercise[data-exercise-id="${planExerciseId}"]`);

                if (!exerciseElement) return;

                loggedExercise.sets.forEach((set, setIndex) => {
                    // For Day 6 cardio, its input IDs are specific
                    if (planExerciseId === 'day6_ex1') {
                        const durationInput = exerciseElement.querySelector(`#${planExerciseId}_s1_duration`);
                        const notesInput = exerciseElement.querySelector(`#${planExerciseId}_s1_notes`);
                        if (durationInput && set.duration) durationInput.value = set.duration;
                        if (notesInput && set.notes) notesInput.value = set.notes;
                    } else { // Standard exercises
                        const setGroupElement = exerciseElement.querySelectorAll('.set-group')[setIndex];
                        if (setGroupElement) { 
                            for (const field in set) {
                                if (field === 'set' || field === 'name') continue; 
                                const inputId = `${planExerciseId}_s${setIndex + 1}_${field}`;
                                const inputElement = document.getElementById(inputId);
                                
                                if (inputElement) {
                                    if (inputElement.type === 'checkbox') {
                                        inputElement.checked = set[field];
                                    } else {
                                        inputElement.value = set[field];
                                    }
                                }
                            }
                        }
                    }
                });
            });
        }
        
        function saveWorkout(dayId) {
            const dayCard = document.getElementById(dayId);
            if (!dayCard) {
                alert('Error: Could not find workout data to save.');
                return;
            }

            const timestamp = new Date();
            const dateString = timestamp.toISOString().slice(0, 10);
            let workoutLog = JSON.parse(localStorage.getItem(WORKOUT_LOG_STORAGE_KEY)) || {}; 
            if (!workoutLog[dateString]) workoutLog[dateString] = {};
            
            const dayTitleElement = dayCard.querySelector('.day-title');
            const dayName = dayTitleElement ? dayTitleElement.textContent.trim() : `Day ${dayId.replace('day','')}`;

            let dayLogEntry = {
                dayName: dayName,
                timestamp: timestamp.toISOString(),
                exercises: []
            };

            // Handle static days like Day 3 (Swimming) and Day 7 (Rest)
            if (dayId === 'day3' || dayId === 'day7') {
                dayLogEntry.exercises.push({ 
                    name: dayName, // Use the day's title as the "exercise name" for logging
                    id: `${dayId}_activity`, // A generic ID for the activity
                    sets: [{ status: "Logged" }] 
                });
            } else { // For days with dynamic exercises
                const exerciseElements = dayCard.querySelectorAll('.exercise');
                exerciseElements.forEach((exerciseEl) => {
                    const exerciseId = exerciseEl.dataset.exerciseId;
                    if (!exerciseId) return; // Skip if no ID (should not happen for planned exercises)

                    const planExercise = exercisePlanData[dayId]?.exercises.find(ex => ex.id === exerciseId);
                    const exerciseName = planExercise ? planExercise.name : (exerciseEl.querySelector('.exercise-name') ? exerciseEl.querySelector('.exercise-name').textContent.trim() : 'Unnamed Exercise');
                    
                    let exerciseDataForLog = { 
                        name: exerciseName, 
                        id: exerciseId, // Store the plan ID with the log
                        sets: [] 
                    };

                    // Special handling for Day 6 Cardio inputs
                    if (exerciseId === 'day6_ex1') {
                        const durationInput = exerciseEl.querySelector(`#${exerciseId}_s1_duration`);
                        const notesInput = exerciseEl.querySelector(`#${exerciseId}_s1_notes`);
                        let setData = {};
                        if (durationInput && durationInput.value.trim() !== '') setData.duration = durationInput.value.trim();
                        if (notesInput && notesInput.value.trim() !== '') setData.notes = notesInput.value.trim();
                        if (Object.keys(setData).length > 0) exerciseDataForLog.sets.push(setData);
                    } 
                    // Handling for Day 6 Core (static part, but has inputs)
                    else if (dayId === 'day6' && exerciseId !== 'day6_ex1') { // Assuming Core part might have an ID or is the other .exercise
                        const completedCheckbox = exerciseEl.querySelector('input[type="checkbox"][id*="completed"]');
                        const notesInput = exerciseEl.querySelector('input[type="text"][id*="notes"]');
                        let setData = {};
                        if (completedCheckbox) setData.completed = completedCheckbox.checked;
                        if (notesInput && notesInput.value.trim() !== '') setData.notes = notesInput.value.trim();
                        if (Object.keys(setData).length > 0 || completedCheckbox) exerciseDataForLog.sets.push(setData); // Log even if just checkbox
                    }
                    else { // Standard set groups for other exercises
                        const setGroups = exerciseEl.querySelectorAll('.set-group');
                        setGroups.forEach((setGroup, setIndex) => {
                            let setData = { set: setIndex + 1 }; 
                            const inputs = setGroup.querySelectorAll('input');
                            inputs.forEach(input => {
                                const fieldId = input.id; // e.g., day1_ex1_s1_weight
                                const fieldNameMatch = fieldId.match(/_s\d+_([a-zA-Z_]+)$/);
                                const fieldName = fieldNameMatch ? fieldNameMatch[1] : fieldId.substring(fieldId.lastIndexOf('_') + 1);
                                
                                if (input.type === 'checkbox') {
                                    setData[fieldName] = input.checked;
                                } else if (input.value.trim() !== '') {
                                    setData[fieldName] = input.value.trim();
                                }
                            });
                            if (Object.keys(setData).length > 1) { 
                                exerciseDataForLog.sets.push(setData);
                            }
                        });
                    }

                    if (exerciseDataForLog.sets.length > 0) {
                         dayLogEntry.exercises.push(exerciseDataForLog);
                    }
                });
            }
            
            workoutLog[dateString][dayId] = dayLogEntry; 
            localStorage.setItem(WORKOUT_LOG_STORAGE_KEY, JSON.stringify(workoutLog));
            alert(dayName + ' progress saved for ' + dateString + '!');
            updateProgressTable();
            generateCalendar(); 
        }


        function updateProgressTable() {
            const workoutLog = JSON.parse(localStorage.getItem(WORKOUT_LOG_STORAGE_KEY)) || {};
            const container = document.getElementById('progress-entries-container');
            if (!container) return;
            container.innerHTML = ''; 

            const sortedDates = Object.keys(workoutLog).sort((a,b) => new Date(b) - new Date(a));

            if (sortedDates.length === 0) {
                 container.innerHTML = '<p style="text-align:center;">No data saved yet. Click "Save Day X Progress" after workouts.</p>';
                 updateOverallSummary(); 
                 return;
            }

            sortedDates.forEach(date => {
                const dateWorkouts = workoutLog[date];
                
                const detailsEl = document.createElement('details');
                detailsEl.classList.add('progress-entry');
                
                const summaryEl = document.createElement('summary');
                let summaryText = date;
                const dayNamesOnDate = Object.values(dateWorkouts).map(entry => entry.dayName).join(' & ');
                summaryText += ` - ${dayNamesOnDate}`;
                summaryEl.textContent = summaryText;
                detailsEl.appendChild(summaryEl);

                const entryDetailsDiv = document.createElement('div');
                entryDetailsDiv.classList.add('progress-entry-details');

                Object.keys(dateWorkouts).forEach(dayIdKey => {
                    const dayEntry = dateWorkouts[dayIdKey];
                    const dayHeader = document.createElement('h4');
                    dayHeader.textContent = dayEntry.dayName;
                    entryDetailsDiv.appendChild(dayHeader);

                    const table = document.createElement('table');
                    table.classList.add('progress-table');
                    const thead = table.createTHead();
                    const headerRow = thead.insertRow();
                    const headers = ['Exercise', 'Set', 'Weight (KG)', 'Reps', 'Hold', 'Duration', 'Notes/Status'];
                    headers.forEach(text => {
                        const th = document.createElement('th');
                        th.textContent = text;
                        headerRow.appendChild(th);
                    });
                    const tbody = table.createTBody();

                    dayEntry.exercises.forEach(exercise => {
                        if (!exercise.sets || exercise.sets.length === 0) { 
                            const row = tbody.insertRow();
                            row.insertCell().textContent = exercise.name;
                            for(let i=0; i<6; i++) row.insertCell().textContent = 'N/A'; 
                        } else if (exercise.sets[0].status) { // Logged days like Rest/Swim
                             const row = tbody.insertRow();
                            row.insertCell().textContent = exercise.name;
                             row.insertCell().textContent = 'N/A'; 
                            row.insertCell().textContent = 'N/A'; 
                            row.insertCell().textContent = 'N/A'; 
                            row.insertCell().textContent = 'N/A'; 
                            row.insertCell().textContent = 'N/A'; 
                            row.insertCell().textContent = exercise.sets[0].status; 
                        }
                        else {
                            exercise.sets.forEach((set, index) => {
                                const row = tbody.insertRow();
                                row.insertCell().textContent = exercise.name;
                                row.insertCell().textContent = set.set || (index + 1); 
                                row.insertCell().textContent = set.weight || 'N/A';
                                row.insertCell().textContent = set.reps || 'N/A';
                                row.insertCell().textContent = set.hold || 'N/A';
                                row.insertCell().textContent = set.duration || 'N/A';
                                row.insertCell().textContent = set.notes || (set.completed !== undefined ? (set.completed ? 'Completed' : 'Not Done') : 'N/A');
                            });
                        }
                    });
                    entryDetailsDiv.appendChild(table);
                });
                detailsEl.appendChild(entryDetailsDiv);
                container.appendChild(detailsEl);
            });
            
            updateOverallSummary();
        }
        
        function updateOverallSummary() {
            const workoutLog = JSON.parse(localStorage.getItem(WORKOUT_LOG_STORAGE_KEY)) || {};
            let workoutsCompleted = 0;
            let totalVolume = 0;

            Object.keys(workoutLog).forEach(date => {
                Object.keys(workoutLog[date]).forEach(dayIdKey => {
                    workoutsCompleted++; 
                    const dayData = workoutLog[date][dayIdKey];
                    if (dayData.exercises) {
                        dayData.exercises.forEach(exercise => {
                            if (exercise.sets) {
                                exercise.sets.forEach(set => {
                                    const weight = parseFloat(set.weight);
                                    const reps = parseInt(set.reps);
                                    if (!isNaN(weight) && !isNaN(reps)) {
                                        totalVolume += weight * reps;
                                    }
                                });
                            }
                        });
                    }
                });
            });

            document.getElementById('workouts-completed').textContent = workoutsCompleted;
            document.getElementById('total-volume').textContent = totalVolume.toLocaleString() + ' (KG x Reps approx)';
        }

        function exportProgress() {
            const workoutLog = JSON.parse(localStorage.getItem(WORKOUT_LOG_STORAGE_KEY)) || {};
            let csvContent = "Date,Day Name,Exercise Name,Set,Weight (KG),Reps,Hold,Duration,Notes/Status\n";

            Object.keys(workoutLog).sort().forEach(date => { 
                Object.keys(workoutLog[date]).forEach(dayIdKey => {
                    const dayEntry = workoutLog[date][dayIdKey];
                    if (dayEntry.exercises) {
                        dayEntry.exercises.forEach(exercise => {
                            if (exercise.sets && exercise.sets.length > 0 && exercise.sets[0].status) { 
                                csvContent += `${date},"${dayEntry.dayName}","${exercise.name}",N/A,N/A,N/A,N/A,N/A,"${exercise.sets[0]?.status || 'Logged'}"\n`;
                            } else if (exercise.sets) {
                                exercise.sets.forEach((set, index) => {
                                    csvContent += `${date},"${dayEntry.dayName}","${exercise.name}",${set.set || (index+1)},${set.weight || ''},${set.reps || ''},${set.hold || ''},${set.duration || ''},"${set.notes || (set.completed !== undefined ? (set.completed ? 'Completed' : 'Not Done') : '')}"\n`;
                                });
                            }
                        });
                    }
                });
            });

            if (csvContent.split("\n").length <= 1) {
                alert("No data to export!");
                return;
            }
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a");
            if (link.download !== undefined) {
                const url = URL.createObjectURL(blob);
                link.setAttribute("href", url);
                link.setAttribute("download", "workout_progress.csv");
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            } else {
                 alert("CSV export not supported by this browser.");
            }
        }
        
        function handleCalendarDayClick(year, month, day) {
            const clickedDate = new Date(year, month, day);
            const dayOfWeek = clickedDate.getDay(); // Sunday = 0, Monday = 1, ..., Saturday = 6

            // User's cycle: Mon=Day3, Tue=Day4, Wed=Day5, Thu=Day6, Fri=Day7, Sat=Day1, Sun=Day2
            const dayMapping = [
                2, // Sunday -> Day 2
                3, // Monday -> Day 3
                4, // Tuesday -> Day 4
                5, // Wednesday -> Day 5
                6, // Thursday -> Day 6
                7, // Friday -> Day 7
                1  // Saturday -> Day 1
            ];
            let targetDayNumber = dayMapping[dayOfWeek];

            const workoutTabButton = document.querySelector('.nav-tab[onclick*="workout"]');
            showTab('workout', workoutTabButton);

            const targetDayButton = document.querySelector(`.day-btn[onclick*="showDay(${targetDayNumber},"]`);
            if (targetDayButton) {
                showDay(targetDayNumber, targetDayButton);
            }
        }

        function generateCalendar() {
            const calendarView = document.getElementById('monthly-calendar-view');
            const workoutLog = JSON.parse(localStorage.getItem(WORKOUT_LOG_STORAGE_KEY)) || {};
            if (!calendarView) return;
            calendarView.innerHTML = ''; 

            const today = new Date();
            const currentMonth = today.getMonth();
            const currentYear = today.getFullYear();
            
            const daysInMonth = new Date(currentYear, currentMonth + 1, 0).getDate();
            let firstDayOfMonth = new Date(currentYear, currentMonth, 1).getDay(); 
            firstDayOfMonth = (firstDayOfMonth === 0) ? 6 : firstDayOfMonth - 1; 

            const dayNames = ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'];
            dayNames.forEach(name => {
                const dayHeader = document.createElement('div');
                dayHeader.classList.add('calendar-day', 'header');
                dayHeader.textContent = name;
                calendarView.appendChild(dayHeader);
            });
            
            for (let i = 0; i < firstDayOfMonth; i++) {
                const emptyCell = document.createElement('div');
                emptyCell.classList.add('calendar-day', 'empty');
                calendarView.appendChild(emptyCell);
            }

            for (let day = 1; day <= daysInMonth; day++) {
                const dayCell = document.createElement('div');
                dayCell.classList.add('calendar-day');
                dayCell.textContent = day;
                
                const dateStr = `${currentYear}-${String(currentMonth + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                if (workoutLog[dateStr] && Object.keys(workoutLog[dateStr]).length > 0) {
                    dayCell.classList.add('workout-complete');
                    let workoutTitles = [];
                     Object.values(workoutLog[dateStr]).forEach(dayLog => {
                        if(dayLog && dayLog.dayName) workoutTitles.push(dayLog.dayName);
                    });
                    dayCell.title = "Logged: " + workoutTitles.join('; ');
                }

                if (day === today.getDate() && currentMonth === today.getMonth() && currentYear === today.getFullYear()) {
                    dayCell.classList.add('today');
                }
                dayCell.onclick = () => handleCalendarDayClick(currentYear, currentMonth, day);
                calendarView.appendChild(dayCell);
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            initializeExercisePlan(); 

            // --- Set initial active day to Day 3 (Swimming) as per user request ---
            document.querySelectorAll('.day-btn.active').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('.day-card.active').forEach(card => card.classList.remove('active'));
            
            const todayIsDay = 3; // Monday is Day 3 (Swimming)
            const targetDayButton = document.querySelector(`.day-btn[onclick*="showDay(${todayIsDay},"]`);
            
            // Ensure showTab is called first to make #workout-tab active if it's not already
            const workoutTabButton = document.querySelector('.nav-tab[onclick*="workout"]');
            if (!workoutTabButton.classList.contains('active')) {
                 showTab('workout', workoutTabButton);
            }

            if (targetDayButton) {
                showDay(todayIsDay, targetDayButton);
            } else { // Fallback
                const fallbackButton = document.querySelector('.day-btn');
                if (fallbackButton) {
                    const fallbackDayNum = parseInt(fallbackButton.getAttribute('onclick').match(/showDay\((\d+)/)[1]);
                    showDay(fallbackDayNum, fallbackButton);
                }
            }
            // --- End of setting initial active day ---
            
            // Wire up "Add New Exercise" buttons
            document.querySelectorAll('.add-new-exercise-btn').forEach(button => {
                button.onclick = () => {
                    const dayId = button.dataset.dayid; 
                    if (!exercisePlanData[dayId]) { 
                        exercisePlanData[dayId] = { exercises: [] };
                    }
                    const newExerciseId = `${dayId}_exNEW_${Date.now()}`;
                    const newExercise = {
                        id: newExerciseId,
                        name: 'New Exercise (Edit Me)',
                        videoLink: '',
                        description: 'Newly added exercise. Click "Edit Exercise" to customize.',
                        alternatives: 'N/A',
                    };
                    exercisePlanData[dayId].exercises.push(newExercise);
                    localStorage.setItem(EXERCISE_PLAN_STORAGE_KEY, JSON.stringify(exercisePlanData));
                    renderExercisesForDay(dayId); 
                    
                    const newExerciseElem = document.querySelector(`.exercise[data-exercise-id="${newExerciseId}"]`);
                    if (newExerciseElem) {
                        newExerciseElem.scrollIntoView({ behavior: 'smooth', block: 'center' });
                        const editBtn = newExerciseElem.querySelector('.edit-exercise-btn');
                        if(editBtn) makeExerciseEditable(newExerciseElem, dayId, newExerciseId);
                    }
                };
            });

            updateProgressTable(); 

            if (typeof Chart === 'undefined') {
                console.warn('Chart.js not loaded. Charts will not be displayed.');
            }
        });
    </script>
</body>
</html>
